(function(){
  var JavaScript = {
    load: function(src, callback) {
      var script = document.createElement('script');
      var loaded;
      script.setAttribute("type","text/javascript");
      script.setAttribute('src', src);
      if (callback) {
        if (script.readyState) {
          script.onreadystatechange = function () { // For old versions of IE
            if (this.readyState == 'complete' || this.readyState == 'loaded') {
              callback();
            }
          };
        } else { // Other browsers
          script.onload = callback;
        }
      }
      (document.getElementsByTagName("head")[0] || document.documentElement).appendChild(script);
    }
  };
  var head= document.getElementsByTagName('head')[0];
  var css= document.createElement('link');
  css.setAttribute("rel", "stylesheet");
  css.setAttribute("type", "text/css");
  css.setAttribute("href", "{{baseUrl}}/stylesheets/app.css");
  head.appendChild(css);

  JavaScript.load('//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js', function() {
    var $winbitsScript = $("script[src$='winbits.js']");
    var userConfig = { verticalId: $winbitsScript.data('vertical'), proxyUrl: $winbitsScript.data('proxy')};
    userConfig.providerUrl = "{{providerUrl}}";
    var Winbits = { userConfig: userConfig };
    Winbits.$ = $.noConflict(true);
    window.Winbits = Winbits;
    window.w$ = Winbits.$;
    JavaScript.load('{{baseUrl}}/javascripts/vendor.js', function() {
      window.Backbone.$ = Winbits.$;
      Winbits.rpc = new easyXDM.Rpc({
        remote: Winbits.userConfig.providerUrl, // the path to the provider
        onReady: function() {
          console.log('Triggering event winbitsrpcready');
          Winbits.$(window.document).trigger('winbitsrpcready');
        }
      }, {
        remote: {
          request:{},
          getTokens:{},
          saveApiToken:{},
          storeVirtualCart:{},
          logout:{},
          facebookStatus:{} ,
          facebookMe:{}
        }
      });
      JavaScript.load('{{baseUrl}}/javascripts/app.js', function() {
        // TODO: No esperar a que se cargue todo el DOM para renderizar el widget. Esperar a que se rederize el container del widget.
        Winbits.$(document).ready(function($) {
          var Application = require('application');
          (new Application).initialize();
        });
      });
    });
  });
})();
